# Project Analysis: SkillGap AI

This document summarizes the current implementation based on repository analysis.

## 1) High-Level Overview

SkillGap AI is a Next.js 14 application that combines:
- Supabase Auth for login/signup and role-aware access
- Postgres + RLS for user-owned learning data
- Gemini-powered generation for tests, recommendations, insights, and mentor chat
- Student/professional onboarding and role-targeted learning roadmap

Core app areas:
- End-user learning app (`/dashboard`, tests, roadmap, insights, profile)
- Admin/mentor workspace (`/admin/*`)
- AI mentor chat with moderation and flagging

## 2) Implementation Map

### Frontend Routes
- Public/auth: `app/page.tsx`, `app/auth/*`
- Learner app: `app/dashboard`, `app/daily-test`, `app/practice-test`, `app/skill-graph`, `app/roadmap`, `app/ai-insights`, `app/mentor-chat`, `app/profile`, `app/onboarding`
- Admin: `app/admin/dashboard`, `app/admin/users`, `app/admin/mentors`, `app/admin/mentor`, `app/admin/flagged`

### API Routes
- AI generation/analysis:
  - `app/api/ai/generate-questions/route.ts`
  - `app/api/ai/recommend-courses/route.ts`
  - `app/api/ai/analyze/route.ts`
  - `app/api/ai/insights/route.ts`
- Test scoring:
  - `app/api/daily-test/submit/route.ts`
  - `app/api/practice-test/submit/route.ts`
- Roadmap:
  - `app/api/roadmap/generate/route.ts`
  - `app/api/roadmap/assess/route.ts`
- Chat:
  - `app/api/chat/send/route.ts`

### Shared Runtime
- Middleware: `middleware.ts`
- Supabase clients: `lib/supabase/browser.ts`, `lib/supabase/server.ts`
- Scoring logic: `lib/gapLogic.ts`
- AI parsing helpers: `lib/gemini.ts`

## 3) Data Model Summary

Base schema (`supabase/schema.sql`) includes:
- Catalog: `skills`, `roles`, `role_skills`, `skill_dependencies`, `resources`, `skill_resources`, `questions`
- User profile/progress: `profiles`, `user_stats`, `user_skill_scores`, `user_roadmap`, `user_resource_completions`
- Attempts: `daily_attempts`, `attempt_answers`, `attempt_skill_scores`
- Utility function: `get_random_questions(p_limit int)`

Feature migrations add:
- Profile expansion for student/professional fields (`001_profile_enhancements.sql`)
- Course recommendations + assessments (`roadmap_courses`, `course_assessments`) (`002_roadmap_courses.sql`)
- AI question cache and adaptive difficulty helper (`ai_generated_questions`, `daily_attempts.difficulty_level`) (`003_ai_questions.sql`)
- Persisted AI insights (`ai_insights`) (`004_ai_insights.sql`)
- Unlimited practice attempts (`practice_attempts`) (`005_practice_tests.sql`)
- Admin/mentor/chat model (`admin_users`, `mentor_assignments`, `chat_conversations`, `chat_messages`) (`supabase/admin/006_chat.sql`)

RLS is enabled broadly and follows:
- User-owned rows for learner data
- Authenticated read access for catalog tables
- Admin/mentor policy extensions for monitoring and moderation tables

## 4) Main Product Flows

### A) Daily Test
1. UI requests AI questions (`/api/ai/generate-questions`), fallback to DB questions via RPC.
2. Answers are posted to `/api/daily-test/submit`.
3. Backend computes correctness, updates:
   - `daily_attempts`
   - `attempt_answers` and `attempt_skill_scores` (DB question path)
   - `user_skill_scores` (weighted blend)
   - `user_stats` (XP/level/streak)

### B) Practice Test
1. UI requests assessment questions (`/api/roadmap/assess`).
2. Submission to `/api/practice-test/submit`.
3. Backend stores `practice_attempts`, updates `user_skill_scores`, and attempts roadmap progression unlocks through dependencies.

### C) Roadmap
1. Priority generation via `/api/roadmap/generate` using role weights + dependency bonus + score category.
2. AI resources generated by `/api/ai/recommend-courses` and written to `roadmap_courses`.
3. UI course/skill assessments drive `course_assessments`, `user_skill_scores`, and `user_roadmap.progress`.

### D) AI Insights
1. On-demand analysis through `/api/ai/analyze`.
2. Persisted JSON result in `ai_insights`.
3. Fast reload via cached read (`/api/ai/insights`).

### E) Mentor Chat
1. User message sent to `/api/chat/send`.
2. Conversation/message rows persisted.
3. Gemini reply generated with user context.
4. Background moderation flags inappropriate user messages in `chat_messages`.

## 5) Strengths

- Good separation between page UI and API route handlers.
- Clear Supabase RLS orientation for user-owned data.
- Practical MVP coverage across onboarding, assessment, roadmap, insights, and admin moderation.
- Reusable helper modules for scoring and Gemini response parsing.

## 6) Risks and Gaps

### Critical
- Client-trusted answer keys in AI test flows:
  - `app/api/daily-test/submit/route.ts` and `app/api/practice-test/submit/route.ts` accept `ai_questions.correct_index` from client payload.
  - A malicious client can inflate scores by tampering payload.
  - For production, keep correct answers server-side only.

### High
- Logout route mismatch:
  - `app/auth/logout/route.ts` exports `POST`.
  - `components/AdminShell.tsx` links to `/auth/logout` via GET link.
  - This likely returns 405 and breaks admin logout path.

### Medium
- Navigation link without route:
  - `components/AdminShell.tsx` includes `/admin/mentor/chat`.
  - No corresponding route currently exists under `app/admin/mentor/chat`.
- Resume upload assumptions:
  - Code expects a public storage bucket `uploads`.
  - Missing bucket/policies cause onboarding/profile resume upload errors.

### Low
- No automated test suite found (unit/integration/e2e).
- AI-generated external resource URLs are not validated before persistence.

## 7) Suggested Next Steps

1. Move answer-key validation fully server-side for AI-generated questions.
2. Fix logout flow (`GET` handler or form POST) and align links.
3. Add missing mentor chat route or remove dead nav link.
4. Add migration or bootstrap script for storage bucket + storage policies.
5. Add baseline tests for:
   - score calculation correctness
   - access control/middleware redirects
   - API route auth and payload validation

## 8) Verification Notes

Static analysis was done directly from source and SQL files.
Runtime checks (lint/build/tests) could not be executed in this environment because Node/npm tooling is unavailable.
